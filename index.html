<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Creative Mornings Egg Logger</title>
	<style>
	body{
		font-family: Helvetica, Arial, sans-serif;
	}
	#status {
		font-size:30vmin;
		font-weight:bold;
		text-align:center;
		position:fixed;
		margin:auto;
		top:0;
		left:0;
		bottom:0;
		right:0;
		height:40vmin;
	}
	
	.source {
		style="margin:auto;
		position:absolute;
		left:2%;
		bottom:2%;
	}
	#timestamp{
		style="margin:auto;
		position:absolute;
		left:2%;
		top:2%;
		font-size:0.8em;
	}
	</style>
</head>
<body>
	<div id="status"></div>
	<select class="source" id="measurementSelect"></select>
	<div id="timestamp"></div>
</body>
	
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/augment.js/1.0.0/augment.min.js"></script>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="https://sdk.amazonaws.com/js/aws-sdk-2.0.0-rc1.min.js"></script>
<!-- AWS SDK info from http://docs.aws.amazon.com/AWSJavaScriptSDK/guide/index.html -->
<script>
$(document).ready(function() {
	// Functions to convert to and from kelvin.  The data in the database is kept
	// in kelvin so it can be converted easily to other units.
	var fahrenheitToKelvin = function(f) {
		return (Number(f) + 459.67)*(5/9);
	};
	var kelvinToFahrenheit = function(k) {
		return Number(k)*(9/5) - 459.67;
	};
	var celsiusToKelvin = function(c) {
		return Number(c) + 273.15;
	};
	var kelvinToCelsius = function(k) {
		return Number(k) - 273.15;
	};

	// Current unit conversion functions.
	var toKelvin = fahrenheitToKelvin;
	var fromKelvin = kelvinToFahrenheit;

	// Temperature data retrieved from database.
	var tempData = null;
	// Most recently retrieved measurement from database.
	var lastseen = null;
            
	/***********************************************************************************
	***********************************************************************************
	**                                                                               **
	**  PUT YOUR READ ONLY USER ACCESS KEYS BELOW:                                   **
	**  Do NOT put your own AWS credentials below as they will be visible to anyone  **
	**  who views this web page!  Use credentials for a user with read-only access   **
	**  to your DynamoDB table.                                                      **
	**                                                                               **
	***********************************************************************************
	***********************************************************************************/
	AWS.config.update({ accessKeyId: 'AKIAIFMBTVXU2C6EBFPA', 
	secretAccessKey: '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' });
            
	/***********************************************************************************
	***********************************************************************************
	**                                                                               **
	**  PUT YOUR DYNAMODB TABLE REGION BELOW:                                        **
	**  See http://docs.aws.amazon.com/general/latest/gr/rande.html#ddb_region for   **
	**  appropriate value.                                                           **           
	**                                                                               **
	***********************************************************************************
	***********************************************************************************/
	AWS.config.region = 'eu-west-1';
	var dynamodb = new AWS.DynamoDB();

	// Query all the unique measurement ids from the database.
	var queryUniqueMeasurements = function(callback) {
		var measurements = {};
		// Grab a page of results from the provided start key.
		var queryPage = function(startkey) {
			var params = {  'TableName': 'temperatures',
			'Select': 'SPECIFIC_ATTRIBUTES',
			'AttributesToGet': ['Id'] };
			if (startkey != null) {
				params['ExclusiveStartKey'] = startkey;
			}
			dynamodb.scan(params, function(err, data) {
				if (data) {
					data.Items.forEach(function(item) {
						// Maintain a set of measurement id values.
						measurements[item.Id.S] = true;
					});
					if (data.LastEvaluatedKey) {
						// More data to retrieve, grab another page.
						queryPage(data.LastEvaluatedKey);
					}
					else {
						// No more data, invoke the callback with results.
						callback(measurements);
					}
				}
			});
		}
		queryPage();
	};

	// Query all the temperatures that were measured after lastseen 
	// for the provided measurement id.
	var queryTemps = function(measurementId, lastseen, callback) {
		var data = [];
		// Grab a page of results from the provided start key.
		var queryPage = function(startkey) {
			var params = {  'TableName': 'temperatures',
			'Select': 'SPECIFIC_ATTRIBUTES',
			'AttributesToGet': ['Date', 'Temp'],
			'KeyConditions' : { 
				'Id': { 
					'AttributeValueList': [ { 'S': measurementId } ],
					'ComparisonOperator': 'EQ'
				}
			} 
		};
		if (startkey != null) {
			params.ExclusiveStartKey = startkey;
		}
		if (lastseen != null) {
			params.KeyConditions['Date'] = {
				'AttributeValueList': [ { 'N': (lastseen.getTime()/1000).toString() } ],
				'ComparisonOperator': 'GT'
			};
		}
		dynamodb.query(params, function(err, newdata) {
			if (newdata) {
				// Add retrieved results to data.
				data = data.concat(newdata.Items.map(function(item) {
					return { date: new Date(Number(item.Date.N)*1000), temp: Number(item.Temp.N) };
				}));
				if (newdata.LastEvaluatedKey) {
					// More data to retrieve, grab another page.
					queryPage(data.LastEvaluatedKey);
				}
				else {
					// No more data, invoke the callback with results.
					callback(data);
				}
			}
		});    
	};
	queryPage();
};
			
// Populate list of temp ID values with data queried from DB.
queryUniqueMeasurements(function(measurements) {
	var measurementSelect = $('#measurementSelect');
	measurementSelect.empty();
	measurementSelect.append("<option value='' disabled selected style='display:none;'>Choose...</option>");
	for (id in measurements) {
		measurementSelect.append('<option>' + id + '</option>');
	}
});

// Update the graph, trend line, and estimated time.
var updateUI = function() {
	$('#status').removeClass();
	$('#status').text(.1*Math.round(10*kelvinToCelsius(tempData[tempData.length-1].temp)) + 'Â°C');
	$('#timestamp').text(lastseen);
};

// Download data from the database and update the data in memory.
var updateData = function() {
	queryTemps($('#measurementSelect').val(), lastseen, function(data) {
		if (tempData == null) {
			tempData = data;
		}
		else {
			tempData = tempData.concat(data);
		}
		// Update UI, etc. if there is data available.
		if (tempData != null && tempData.length > 0) {
			// Update most recent measurement time.
			lastseen = tempData[tempData.length-1].date;
			updateUI();
		}
	});
};

// Draw graph when measurement is selected.
$('#measurementSelect').change(function() {
	lastseen = null;
	tempData = null;
	updateData();
});

// Create auto update timer to run once a minute.
var timer = window.setInterval(function() {
	// Update the data if auto updates are turned on and a measurement is selected.
	updateData();
}, 10*1000);
});
</script>
</html>

